<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>FlashLearn Pro - å¤šæ©Ÿèƒ½é–“éš”åå¾©å­¦ç¿’</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans JP',-apple-system,BlinkMacSystemFont,sans-serif;background:#0f0f0f;color:#fff;min-height:100vh}
    .loading-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px}
    .loading-spinner{width:48px;height:48px;border:3px solid rgba(99,102,241,.2);border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#0f0f0f,#1a1a2e)}
    .login-card{width:100%;max-width:380px;padding:48px 32px;border-radius:24px;background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1)}
    .logo-container{text-align:center;margin-bottom:40px}
    .logo{width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 8px 32px rgba(99,102,241,.3)}
    .logo svg{width:36px;height:36px;color:#fff}
    .app-title{font-size:32px;font-weight:700;margin:0 0 8px;background:linear-gradient(135deg,#fff,#a5b4fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .app-subtitle{font-size:14px;color:rgba(255,255,255,.5)}
    .google-button{width:100%;padding:16px 24px;font-size:16px;font-weight:600;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:.2s}
    .google-button:hover{background:rgba(255,255,255,.1)}
    .google-button svg{width:20px;height:20px}
    .app-container{min-height:100vh;display:none}
    .app-container.active{display:block}
    .screen{min-height:100vh;padding:24px;padding-bottom:100px;display:none}
    .screen.active{display:block}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
    .greeting{font-size:14px;color:rgba(255,255,255,.5)}
    .user-name{font-size:28px;font-weight:700;margin:4px 0 0}
    .header-right{display:flex;align-items:center;gap:12px}
    .streak-badge{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;background:rgba(249,115,22,.15);color:#f97316;font-weight:600}
    .logout-button{width:40px;height:40px;border-radius:12px;border:none;background:rgba(255,255,255,.05);color:rgba(255,255,255,.6);cursor:pointer;display:flex;align-items:center;justify-content:center}
    .study-card{position:relative;border-radius:24px;padding:32px;margin-bottom:24px;overflow:hidden;background:linear-gradient(135deg,#6366f1,#8b5cf6)}
    .study-card-content{position:relative;z-index:1}
    .study-card-bg{position:absolute;top:-50%;right:-20%;width:200px;height:200px;border-radius:50%;background:rgba(255,255,255,.1)}
    .due-number{font-size:56px;font-weight:700;display:block;line-height:1}
    .due-label{font-size:16px;opacity:.8}
    .due-info{margin-bottom:20px}
    .study-button{display:inline-flex;align-items:center;gap:10px;padding:14px 28px;font-size:16px;font-weight:600;border-radius:12px;border:none;background:#fff;color:#6366f1;cursor:pointer}
    .study-button:disabled{opacity:.5;cursor:not-allowed}
    .stats-row{display:flex;gap:12px;margin-bottom:32px}
    .stat-box{flex:1;padding:16px;border-radius:16px;background:rgba(255,255,255,.05);text-align:center}
    .stat-number{font-size:24px;font-weight:700;display:block}
    .stat-label{font-size:12px;color:rgba(255,255,255,.5)}
    .action-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .action-card{padding:20px 16px;border-radius:16px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:12px;color:#fff}
    .action-icon{width:44px;height:44px;border-radius:12px;background:rgba(99,102,241,.15);color:#818cf8;display:flex;align-items:center;justify-content:center}
    .action-label{font-size:13px;font-weight:500;color:rgba(255,255,255,.8)}
    .sub-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px}
    .back-button{width:40px;height:40px;border-radius:12px;border:none;background:rgba(255,255,255,.05);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .sub-title{font-size:20px;font-weight:600}
    .create-form{display:flex;flex-direction:column;gap:20px}
    .input-group{display:flex;flex-direction:column;gap:8px}
    .input-group label{font-size:14px;font-weight:500;color:rgba(255,255,255,.7)}
    .input-group textarea, .input-group input, .input-group select{width:100%;padding:14px;font-size:16px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;outline:none;font-family:inherit}
    .primary-button{padding:16px 32px;font-size:16px;font-weight:600;border-radius:12px;border:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;cursor:pointer;box-shadow:0 4px 16px rgba(99,102,241,.3)}
    .primary-button:disabled{opacity:.5;cursor:not-allowed}
    .card-list{display:flex;flex-direction:column;gap:12px}
    .card-item{display:flex;align-items:center;padding:16px;border-radius:12px;background:rgba(255,255,255,.05)}
    .card-item-content{flex:1;min-width:0}
    .card-front{font-size:15px;font-weight:600;margin:0 0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-back{font-size:13px;color:rgba(255,255,255,.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .delete-button, .import-button{width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-left:12px}
    .delete-button{background:rgba(239,68,68,.1);color:#ef4444}
    .import-button{background:rgba(99,102,241,.2);color:#818cf8}
    .study-screen{min-height:100vh;display:flex;flex-direction:column;padding:24px;background:#0f0f0f}
    .study-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .flashcard-image{max-width:100%;max-height:180px;border-radius:12px;margin-bottom:16px;object-fit:contain}
    .flashcard{width:100%;max-width:400px;min-height:320px;padding:32px;border-radius:24px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);padding:12px 24px;border-radius:12px;background:rgba(34,197,94,.9);color:#fff;font-weight:500;opacity:0;transition:.3s;z-index:1000}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .hidden{display:none!important}
    .answer-buttons{display:flex;gap:16px;padding-top:24px}
    .answer-button{flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border-radius:16px;border:none;font-weight:600;cursor:pointer}
    .again-button{background:rgba(239,68,68,.15);color:#ef4444}
    .good-button{background:rgba(34,197,94,.15);color:#22c55e}
  </style>
</head>
<body>
  <div id="loading-screen" class="loading-screen"><div class="loading-spinner"></div><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>
  
  <div id="login-screen" class="login-container hidden">
    <div class="login-card">
      <div class="logo-container">
        <div class="logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2a4 4 0 00-4 4c0 1.5.8 2.8 2 3.5V12H8a4 4 0 00-4 4c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4a4 4 0 00-4-4h-2V9.5c1.2-.7 2-2 2-3.5a4 4 0 00-4-4z"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/></svg></div>
        <h1 class="app-title">FlashLearn</h1>
        <p class="app-subtitle">å¤šæ©Ÿèƒ½Ã—åŠ¹ç‡çš„ãªé–“éš”åå¾©å­¦ç¿’</p>
      </div>
      <button id="google-login-btn" class="google-button">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="app-container" class="app-container">
    <div id="home-screen" class="screen active">
      <header class="header">
        <div><p class="greeting">ãŠã‹ãˆã‚Šãªã•ã„</p><h1 class="user-name" id="user-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</h1></div>
        <div class="header-right">
          <button id="logout-btn" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </header>
      <div class="study-card">
        <div class="study-card-content">
          <div class="due-info"><span class="due-number" id="due-count">0</span><span class="due-label">æšãŒå¾©ç¿’å¾…ã¡</span></div>
          <button id="start-study-btn" class="study-button" disabled>å­¦ç¿’ã‚’é–‹å§‹</button>
        </div>
        <div class="study-card-bg"></div>
      </div>
      <div class="action-grid">
        <button class="action-card" data-screen="create"><div class="action-icon">+</div><span class="action-label">ä½œæˆ</span></button>
        <button class="action-card" data-screen="manage"><div class="action-icon">â˜°</div><span class="action-label">ç®¡ç†</span></button>
        <button class="action-card" data-screen="explore"><div class="action-icon">ğŸŒ</div><span class="action-label">å…±æœ‰ã‚’æ¢ã™</span></button>
        <button class="action-card" data-screen="stats"><div class="action-icon">ğŸ“Š</div><span class="action-label">çµ±è¨ˆ</span></button>
      </div>
    </div>

    <div id="create-screen" class="screen">
      <header class="sub-header"><button class="back-button" data-screen="home">â†</button><h2 class="sub-title">æ–°ã—ã„ã‚«ãƒ¼ãƒ‰</h2><div style="width:40px"></div></header>
      <div class="create-form">
        <div class="input-group"><label>å•é¡Œï¼ˆè¡¨é¢ï¼‰</label><textarea id="card-front" rows="3"></textarea></div>
        <div class="input-group"><label>ç­”ãˆï¼ˆè£é¢ï¼‰</label><textarea id="card-back" rows="3"></textarea></div>
        <div class="input-group"><label>ç”»åƒï¼ˆä»»æ„ï¼‰</label><input type="file" id="card-image-input" accept="image/*"></div>
        <div class="input-group"><label>å¾©ç¿’é »åº¦</label>
          <select id="card-frequency">
            <option value="0.7">é »ç¹ã«ï¼ˆçŸ­æœŸé–“ï¼‰</option>
            <option value="1.0" selected>æ¨™æº–</option>
            <option value="1.5">ã‚†ã£ãã‚Šï¼ˆé•·æœŸé–“ï¼‰</option>
          </select>
        </div>
        <div class="input-group" style="flex-direction:row;gap:10px;"><input type="checkbox" id="card-is-public"><label for="card-is-public">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã™ã‚‹</label></div>
        <button id="save-card-btn" class="primary-button">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>

    <div id="manage-screen" class="screen">
      <header class="sub-header"><button class="back-button" data-screen="home">â†</button><h2 class="sub-title">ã‚«ãƒ¼ãƒ‰ç®¡ç†</h2><div style="width:40px"></div></header>
      <div id="card-list" class="card-list"></div>
    </div>

    <div id="explore-screen" class="screen">
      <header class="sub-header"><button class="back-button" data-screen="home">â†</button><h2 class="sub-title">å…¬é–‹ã‚«ãƒ¼ãƒ‰ã‚’æ¢ã™</h2><div style="width:40px"></div></header>
      <div id="explore-list" class="card-list"></div>
    </div>

    <div id="study-screen" class="screen study-screen">
      <header class="study-header"><button id="quit-study-btn" class="quit-button">ä¸­æ–­</button><span><span id="study-current">0</span> / <span id="study-total">0</span></span></header>
      <div id="flashcard-container" class="flashcard-container">
        <div class="flashcard">
          <img id="flashcard-image" class="flashcard-image hidden" src="">
          <p id="flashcard-front" style="font-size:24px; font-weight:600;"></p>
          <p id="tap-hint" style="margin-top:20px; opacity:0.3;">ã‚¿ãƒƒãƒ—ã—ã¦ç­”ãˆã‚’è¡¨ç¤º</p>
          <div id="answer-area" class="hidden" style="width:100%">
            <hr style="margin:20px 0; border:none; border-top:1px solid rgba(255,255,255,0.1)">
            <p id="flashcard-answer" style="font-size:24px; color:#22c55e; font-weight:600;"></p>
          </div>
        </div>
      </div>
      <div id="answer-buttons" class="answer-buttons hidden">
        <button class="answer-button again-button" data-quality="0">ã‚‚ã†ä¸€åº¦</button>
        <button class="answer-button good-button" data-quality="2">æ­£è§£</button>
      </div>
    </div>

    <div id="complete-screen" class="screen">
      <div style="text-align:center; padding-top:100px;">
        <h2>ğŸ‰ å­¦ç¿’å®Œäº†ï¼</h2>
        <button id="back-home-btn" class="primary-button" style="margin-top:40px;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
      </div>
    </div>

    <div id="stats-screen" class="screen">
      <header class="sub-header"><button class="back-button" data-screen="home">â†</button><h2 class="sub-title">çµ±è¨ˆ</h2><div style="width:40px"></div></header>
      <div id="stats-container"></div>
    </div>
  </div>

  <div id="toast" class="toast">å®Œäº†ï¼</div>

  <script>
    const SUPABASE_URL='https://rmexndmaqndgolqcfyqh.supabase.co';
    const SUPABASE_ANON_KEY='sb_publishable_-RdUie8ph72WcnBavPFR5A_Of-3E6oM';
    const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    let currentUser=null, cards=[], studySession=null, showingAnswer=false;
    const $=id=>document.getElementById(id);

    async function init(){
      const {data:{session}} = await db.auth.getSession();
      if(session){ currentUser=session.user; await loadUserData(); showApp(); } else { showLogin(); }
      db.auth.onAuthStateChange(async(e,s)=>{
        if(e==='SIGNED_IN'&&s){ currentUser=s.user; await loadUserData(); showApp(); }
        else if(e==='SIGNED_OUT'){ currentUser=null; showLogin(); }
      });
    }

    function showLogin(){ $('loading-screen').classList.add('hidden'); $('login-screen').classList.remove('hidden'); $('app-container').classList.remove('active'); }
    function showApp(){ $('loading-screen').classList.add('hidden'); $('login-screen').classList.add('hidden'); $('app-container').classList.add('active'); updateHomeScreen(); }
    
    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      $(id+'-screen').classList.add('active');
      if(id==='home') updateHomeScreen();
      if(id==='manage') updateManageScreen();
      if(id==='explore') updateExploreScreen();
    }

    async function loadUserData(){
      if(!currentUser) return;
      const {data} = await db.from('cards').select('*').eq('user_id', currentUser.id).order('created_at', {ascending:false});
      cards = data || [];
    }

    function updateHomeScreen(){
      const due = cards.filter(c=>!c.next_review_date || new Date(c.next_review_date) <= new Date());
      $('due-count').textContent = due.length;
      $('user-name').textContent = (currentUser.user_metadata.full_name || currentUser.email.split('@')[0]) + 'ã•ã‚“';
      $('start-study-btn').disabled = due.length === 0;
    }

    async function saveCard(){
      const front=$('card-front').value.trim(), back=$('card-back').value.trim();
      const imageFile=$('card-image-input').files[0];
      const weight=parseFloat($('card-frequency').value);
      const isPublic=$('card-is-public').checked;
      if(!front || !back) return;

      let imageUrl = null;
      if(imageFile){
        const fileName = `${currentUser.id}/${Date.now()}_${imageFile.name}`;
        const {data, error} = await db.storage.from('card-images').upload(fileName, imageFile);
        if(!error){
          const {data:pUrl} = db.storage.from('card-images').getPublicUrl(fileName);
          imageUrl = pUrl.publicUrl;
        }
      }

      const {data, error} = await db.from('cards').insert({
        user_id: currentUser.id, front, back, image_url: imageUrl, 
        frequency_weight: weight, is_public: isPublic,
        interval:0, ease_factor:2.5, repetitions:0
      }).select().single();

      if(!error){
        cards.unshift(data);
        showToast('ä¿å­˜ã—ã¾ã—ãŸ');
        $('card-front').value=''; $('card-back').value=''; $('card-image-input').value='';
        showScreen('home');
      }
    }

    function updateManageScreen(){
      const list = $('card-list');
      list.innerHTML = cards.length ? cards.map(c=>`
        <div class="card-item">
          <div class="card-item-content">
            <p class="card-front">${esc(c.front)}</p>
            <p class="card-back">${esc(c.back)} ${c.is_public?'ğŸŒ':''}</p>
          </div>
          <button class="delete-button" onclick="deleteCard('${c.id}')">æ¶ˆ</button>
        </div>
      `).join('') : '<p class="empty-state">ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }

    async function updateExploreScreen(){
      const {data} = await db.from('cards').select('*').eq('is_public', true).neq('user_id', currentUser.id);
      const list = $('explore-list');
      list.innerHTML = data && data.length ? data.map(c=>`
        <div class="card-item">
          <div class="card-item-content">
            <p class="card-front">${esc(c.front)}</p>
            <p class="card-back">ä½œè€…: ${c.user_id.substring(0,5)}...</p>
          </div>
          <button class="import-button" onclick="importCard('${c.id}')">ï¼‹</button>
        </div>
      `).join('') : '<p class="empty-state">å…¬é–‹ä¸­ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
    }

    async function importCard(id){
      const {data: original} = await db.from('cards').select('*').eq('id', id).single();
      if(original){
        const {data, error} = await db.from('cards').insert({
          user_id: currentUser.id, front: original.front, back: original.back, 
          image_url: original.image_url, frequency_weight: 1.0, is_public: false,
          interval:0, ease_factor:2.5, repetitions:0
        }).select().single();
        if(!error) { cards.unshift(data); showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ'); }
      }
    }

    async function deleteCard(id){
      if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      await db.from('cards').delete().eq('id', id);
      cards = cards.filter(c=>c.id!==id);
      updateManageScreen();
    }

    function startStudy(){
      const due = cards.filter(c=>!c.next_review_date || new Date(c.next_review_date) <= new Date());
      studySession = { cards: due.sort(()=>Math.random()-0.5), index: 0, total: due.length };
      showScreen('study');
      updateStudyCard();
    }

    function updateStudyCard(){
      const c = studySession.cards[studySession.index];
      $('study-current').textContent = studySession.index + 1;
      $('study-total').textContent = studySession.total;
      $('flashcard-front').textContent = c.front;
      $('flashcard-answer').textContent = c.back;
      
      if(c.image_url){
        $('flashcard-image').src = c.image_url;
        $('flashcard-image').classList.remove('hidden');
      } else {
        $('flashcard-image').classList.add('hidden');
      }

      $('answer-area').classList.add('hidden');
      $('answer-buttons').classList.add('hidden');
      $('tap-hint').classList.remove('hidden');
      showingAnswer = false;
    }

    function showAnswer(){
      showingAnswer = true;
      $('answer-area').classList.remove('hidden');
      $('answer-buttons').classList.remove('hidden');
      $('tap-hint').classList.add('hidden');
    }

    async function handleAnswer(q){
      const c = studySession.cards[studySession.index];
      // åå¾©ãƒ­ã‚¸ãƒƒã‚¯ (frequency_weightã‚’è€ƒæ…®)
      let i = c.interval || 0, ef = c.ease_factor || 2.5, r = c.repetitions || 0;
      const weight = c.frequency_weight || 1.0;

      if(q < 2){ r = 0; i = 1; } 
      else { i = r === 0 ? 1 : r === 1 ? 3 : Math.round(i * ef * weight); r++; }
      ef = Math.max(1.3, ef + (0.1 - (2 - q) * (0.08 + (2 - q) * 0.02)));

      const nextDate = new Date();
      nextDate.setDate(nextDate.getDate() + i);

      const updates = { interval: i, ease_factor: ef, repetitions: r, next_review_date: nextDate.toISOString() };
      await db.from('cards').update(updates).eq('id', c.id);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
      const idx = cards.findIndex(x=>x.id===c.id);
      if(idx>-1) cards[idx] = {...cards[idx], ...updates};

      if(studySession.index < studySession.total - 1){
        studySession.index++;
        updateStudyCard();
      } else {
        showScreen('complete');
      }
    }

    function showToast(m){ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    function esc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

    $('google-login-btn').onclick = () => db.auth.signInWithOAuth({provider:'google'});
    $('logout-btn').onclick = () => db.auth.signOut();
    $('save-card-btn').onclick = saveCard;
    $('start-study-btn').onclick = startStudy;
    $('flashcard-container').onclick = () => { if(!showingAnswer) showAnswer(); };
    $('quit-study-btn').onclick = () => showScreen('home');
    $('back-home-btn').onclick = () => showScreen('home');
    document.querySelectorAll('[data-screen]').forEach(b=>b.onclick=()=>showScreen(b.dataset.screen));
    document.querySelectorAll('.answer-button').forEach(b=>b.onclick=()=>handleAnswer(parseInt(b.dataset.quality)));

    init();
  </script>
</body>
</html>


